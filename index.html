<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>11.15 Ofrendas – Login</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#16a34a;
      --line:#e5e7eb;
      --radius:16px;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .card{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
    }
    h1{ font-size:18px; margin:0 0 10px; }
    p{ margin:0 0 14px; color:var(--muted); line-height:1.35; }
    .btn{
      width:100%;
      border:0;
      border-radius:999px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-ghost{ background:#111827; color:white; margin-top:10px; }
    .row{ display:flex; gap:10px; align-items:center; }
    img.avatar{ width:44px; height:44px; border-radius:999px; border:1px solid var(--line); }
    .hidden{ display:none; }
    code{ background:#f3f4f6; padding:2px 6px; border-radius:8px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <h1>Registro de Ofrendas</h1>
    <p id="status">Cargando sesión…</p>

    <div id="loggedOut">
      <button id="btnGoogle" class="btn btn-primary">Ingresar con Gmail (Google)</button>
      <p style="margin-top:12px;font-size:13px;">
        Usamos Google para identificarte y registrar tu usuario en la base de datos.
      </p>
    </div>

    <div id="loggedIn" class="hidden">
      <div class="row" style="margin-bottom:12px;">
        <img id="avatar" class="avatar" alt="avatar" />
        <div>
          <div id="name" style="font-weight:800;"></div>
          <div id="email" style="color:var(--muted); font-size:13px;"></div>
        </div>
      </div>

      <p style="font-size:13px;">
        Tu usuario está listo. ID: <code id="uid"></code>
      </p>

      <button id="btnLogout" class="btn btn-ghost">Cerrar sesión</button>
    </div>
  </div>

  <script>
    // 1) Pega aquí tus keys (Settings → API)
    const SUPABASE_URL = "PEGA_AQUI_TU_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "PEGA_AQUI_TU_SUPABASE_ANON_KEY";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const elStatus = document.getElementById("status");
    const elLoggedOut = document.getElementById("loggedOut");
    const elLoggedIn = document.getElementById("loggedIn");
    const elName = document.getElementById("name");
    const elEmail = document.getElementById("email");
    const elUid = document.getElementById("uid");
    const elAvatar = document.getElementById("avatar");

    function showLoggedOut(msg){
      elStatus.textContent = msg || "No has iniciado sesión.";
      elLoggedOut.classList.remove("hidden");
      elLoggedIn.classList.add("hidden");
    }

    function showLoggedIn(user){
      const meta = user.user_metadata || {};
      elStatus.textContent = "Sesión activa ✅";
      elLoggedOut.classList.add("hidden");
      elLoggedIn.classList.remove("hidden");
      elName.textContent = meta.full_name || meta.name || "Usuario";
      elEmail.textContent = user.email || "";
      elUid.textContent = user.id;
      elAvatar.src = meta.avatar_url || "https://www.gravatar.com/avatar/?d=mp";
    }

    async function refreshUI(){
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) {
        console.error(error);
        showLoggedOut("Error leyendo sesión.");
        return;
      }
      const session = data.session;
      if (!session?.user) {
        showLoggedOut("No has iniciado sesión.");
        return;
      }
      showLoggedIn(session.user);

      // Bonus: confirmar que el perfil existe (lo crea el trigger)
      const { data: prof, error: pe } = await supabaseClient
        .from("user_profiles")
        .select("user_id, email, full_name, last_login_at")
        .eq("user_id", session.user.id)
        .maybeSingle();

      if (pe) console.warn("No pude leer user_profiles (RLS/Policy):", pe);
      else console.log("Perfil en user_profiles ✅", prof);
    }

    document.getElementById("btnGoogle").addEventListener("click", async () => {
      // En GitHub Pages, esto debe coincidir con tus Redirect URLs en Supabase
      const redirectTo = window.location.origin + window.location.pathname;

      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo }
      });

      if (error) {
        console.error(error);
        alert("No se pudo iniciar sesión con Google.");
      }
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      const { error } = await supabaseClient.auth.signOut();
      if (error) console.error(error);
      showLoggedOut("Sesión cerrada.");
    });

    // Reaccionar a cambios de sesión (login/logout)
    supabaseClient.auth.onAuthStateChange((_event, _session) => {
      refreshUI();
    });

    // Cargar UI inicial
    refreshUI();
  </script>
</body>
</html>
