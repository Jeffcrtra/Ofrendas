<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>2.41 Ofrendas ‚Äì Login</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#16a34a;
      --line:#e5e7eb;
      --radius:16px;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .card{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
    }
    h1{ font-size:18px; margin:0 0 10px; }
    p{ margin:0 0 14px; color:var(--muted); line-height:1.35; }
    .btn{
      width:100%;
      border:0;
      border-radius:999px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-ghost{ background:#111827; color:white; margin-top:10px; }
    .row{ display:flex; gap:10px; align-items:center; }
    img.avatar{ width:44px; height:44px; border-radius:999px; border:1px solid var(--line); }
    .hidden{ display:none; }
    code{ background:#f3f4f6; padding:2px 6px; border-radius:8px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    
    .tile{
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 12px;
      background:white;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    
    .tile:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    
    .tile:active{
      transform: scale(.97);
    }
    
    .icon{
      font-size:32px;
    }
    
    .label{
      font-size:14px;
      font-weight:700;
      text-align:center;
      line-height:1.2;
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <h1>Registro de Ofrendas</h1>
    <p id="status">Cargando sesi√≥n‚Ä¶</p>

    <div id="loggedOut">
      <button id="btnGoogle" class="btn btn-primary">Ingresar con Gmail (Google)</button>
      <p style="margin-top:12px;font-size:13px;">
        Usamos Google para identificarte y registrar tu usuario en la base de datos.
      </p>
    </div>

    <div id="loggedIn" class="hidden">
      <div class="row" style="margin-bottom:12px;">
        <img id="avatar" class="avatar" alt="avatar" />
        <div>
          <div id="name" style="font-weight:800;"></div>
          <div id="email" style="color:var(--muted); font-size:13px;"></div>
        </div>
      </div>

      <p style="font-size:13px;">
        Tu usuario est√° listo. ID: <code id="uid"></code>
      </p>

      <div id="dashboard" style="margin:16px 0;">
        <div class="grid">
          <button class="tile" data-action="ofrenda">
            <div class="icon">üí∞</div>
            <div class="label">Ingresar<br>Ofrenda</div>
          </button>
      
          <button class="tile" data-action="egreso">
            <div class="icon">üìâ</div>
            <div class="label">Ingresar<br>Egreso</div>
          </button>
      
          <button class="tile" data-action="reportes">
            <div class="icon">üìä</div>
            <div class="label">Reportes</div>
          </button>
      
          <button class="tile" data-action="config">
            <div class="icon">‚öôÔ∏è</div>
            <div class="label">Configuraci√≥n</div>
          </button>
        </div>
      </div>
      
      <button id="btnLogout" class="btn btn-ghost">Cerrar sesi√≥n</button>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = "https://zcsuldbyhxsapyxfzuht.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpjc3VsZGJ5aHhzYXB5eGZ6dWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NDA5OTMsImV4cCI6MjA4NjMxNjk5M30.PT-y2F1LSl_xmSOlfL8JKhPgGbytmh35i_oVfIb_pts";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const elStatus = document.getElementById("status");
    const elLoggedOut = document.getElementById("loggedOut");
    const elLoggedIn = document.getElementById("loggedIn");
    const elName = document.getElementById("name");
    const elEmail = document.getElementById("email");
    const elUid = document.getElementById("uid");
    const elAvatar = document.getElementById("avatar");

    let welcomeAttemptedForUserId = null;

    function showLoggedOut(msg){
      elStatus.textContent = msg || "No has iniciado sesi√≥n.";
      elLoggedOut.classList.remove("hidden");
      elLoggedIn.classList.add("hidden");
    }

    function showLoggedIn(user){
      const meta = user.user_metadata || {};
      elStatus.textContent = "Sesi√≥n activa ‚úÖ";
      elLoggedOut.classList.add("hidden");
      elLoggedIn.classList.remove("hidden");
      elName.textContent = meta.full_name || meta.name || "Usuario";
      elEmail.textContent = user.email || "";
      elUid.textContent = user.id;
      elAvatar.src = meta.avatar_url || "https://www.gravatar.com/avatar/?d=mp";
    }

    async function invokeWelcomeOnce(userId) {
      // Evitar spam: solo 1 intento por userId en esta carga de p√°gina
      if (!userId) return;
      if (welcomeAttemptedForUserId === userId) return;
      welcomeAttemptedForUserId = userId;

      const { data: s } = await supabaseClient.auth.getSession();
      const accessToken = s?.session?.access_token;
      if (!accessToken) return;

      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/send-welcome`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({}),
        });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { raw: text }; }

        if (!res.ok) {
          // IMPORTANT: esto NO debe tumbar la sesi√≥n / UI.
          console.warn("send-welcome failed", res.status, json);
          return;
        }
        console.log("send-welcome ok", json);
      } catch (e) {
        console.warn("send-welcome request failed:", e);
      }
    }

    async function confirmProfile(userId){
      // No rompe nada si falla (RLS/Policy/etc)
      const { data: prof, error: pe } = await supabaseClient
        .from("user_profiles")
        .select("user_id, email, full_name, last_login_at")
        .eq("user_id", userId)
        .maybeSingle();

      if (pe) console.warn("No pude leer user_profiles (RLS/Policy):", pe);
      else console.log("Perfil en user_profiles ‚úÖ", prof);
    }

    async function refreshUI(){
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) {
        console.warn("getSession error:", error);
        showLoggedOut("Error leyendo sesi√≥n.");
        return;
      }

      const session = data?.session;
      if (!session?.user) {
        showLoggedOut("No has iniciado sesi√≥n.");
        return;
      }

      const user = session.user;
      showLoggedIn(user);

      // 1) Confirmar perfil (trigger) sin romper UI si falla
      confirmProfile(user.id);

      // 2) Enviar welcome (si corresponde) sin romper UI si falla
      invokeWelcomeOnce(user.id);
    }

    document.getElementById("btnGoogle").addEventListener("click", async () => {
      const redirectTo = "https://jeffcrtra.github.io/Ofrendas/index.html";
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo }
      });

      if (error) {
        console.error(error);
        alert("No se pudo iniciar sesi√≥n con Google.");
      }
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      // reset de guard para que si vuelve a entrar en la misma sesi√≥n del browser, intente de nuevo
      welcomeAttemptedForUserId = null;

      const { error } = await supabaseClient.auth.signOut();
      if (error) console.error(error);
      showLoggedOut("Sesi√≥n cerrada.");
    });

    // Cambios de sesi√≥n (login/logout)
    supabaseClient.auth.onAuthStateChange((_event, _session) => {
      refreshUI();
    });

    // Inicial
    refreshUI();


    document.querySelectorAll(".tile").forEach(btn => {
      btn.addEventListener("click", () => {
        const action = btn.dataset.action;
    
        switch(action){
          case "ofrenda":
            alert("Aqu√≠ va el formulario de OFRENDA");
            break;
    
          case "egreso":
            alert("Aqu√≠ va el formulario de EGRESO");
            break;
    
          case "reportes":
            alert("Aqu√≠ van los REPORTES");
            break;
    
          case "config":
            alert("Aqu√≠ va CONFIGURACI√ìN");
            break;
        }
      });
    });
  </script>
</body>
</html>

