<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>3.01 Ofrendas ‚Äì App</title>

  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#16a34a;
      --line:#e5e7eb;
      --radius:16px;
      --danger:#ef4444;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .card{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
    }
    h1{ font-size:18px; margin:0 0 10px; }
    p{ margin:0 0 14px; color:var(--muted); line-height:1.35; }

    .btn{
      width:100%;
      border:0;
      border-radius:999px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
    }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-ghost{ background:#111827; color:white; }
    .btn-soft{ background:#eef2ff; color:#111827; border:1px solid var(--line); }
    .btn-danger{ background:var(--danger); color:white; }

    .row{ display:flex; gap:10px; align-items:center; }
    img.avatar{ width:44px; height:44px; border-radius:999px; border:1px solid var(--line); }
    .hidden{ display:none; }
    code{ background:#f3f4f6; padding:2px 6px; border-radius:8px; }

    /* dashboard */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin:16px 0;
    }
    .tile{
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 12px;
      background:white;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .tile:hover{ transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .tile:active{ transform: scale(.97); }
    .icon{ font-size:32px; }
    .label{ font-size:14px; font-weight:800; text-align:center; line-height:1.2; }

    /* views + form */
    .view{ margin-top:14px; border-top:1px solid var(--line); padding-top:14px; }
    .viewHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .viewTitle{ font-size:15px; font-weight:900; }
    .btn-inline{ width:auto; padding:10px 14px; border-radius:999px; font-weight:800; }

    .field{ margin:10px 0; }
    .field label{ display:block; font-size:12px; font-weight:800; color:#111827; margin-bottom:6px; }
    .input, .select, .textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .textarea{ min-height:90px; resize:vertical; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:#111827;
      font-size:13px;
    }
    .toast.ok{ border-color: #bbf7d0; background:#f0fdf4; }
    .toast.err{ border-color: #fecaca; background:#fef2f2; color:#7f1d1d; }
    .list{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .listRow{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .listRow:last-child{ border-bottom:none; }
    .small{ font-size:12px; color:var(--muted); }
    .miniBtn{
      width:auto;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="card">
    <h1>Registro de Ofrendas</h1>
    <p id="status">Cargando sesi√≥n‚Ä¶</p>

    <div id="loggedOut">
      <button id="btnGoogle" class="btn btn-primary">Ingresar con Gmail (Google)</button>
      <p style="margin-top:12px;font-size:13px;">
        Usamos Google para identificarte y registrar tu usuario en la base de datos.
      </p>
    </div>

    <div id="loggedIn" class="hidden">
      <div class="row" style="margin-bottom:12px;">
        <img id="avatar" class="avatar" alt="avatar" />
        <div>
          <div id="name" style="font-weight:900;"></div>
          <div id="email" style="color:var(--muted); font-size:13px;"></div>
        </div>
      </div>

      <!-- DASHBOARD 2x2 -->
      <div id="dashboard" class="grid">
        <button class="tile" data-open="ofrenda">
          <div class="icon">üí∞</div>
          <div class="label">Ingresar<br>Ofrenda</div>
        </button>

        <button class="tile" data-open="egreso">
          <div class="icon">üìâ</div>
          <div class="label">Ingresar<br>Egreso</div>
        </button>

        <button class="tile" data-open="reportes">
          <div class="icon">üìä</div>
          <div class="label">Reportes</div>
        </button>

        <button class="tile" data-open="config">
          <div class="icon">‚öôÔ∏è</div>
          <div class="label">Configuraci√≥n</div>
        </button>
      </div>

      <!-- VIEW: OFRENDA -->
      <div id="viewOfrenda" class="view hidden">
        <div class="viewHeader">
          <div class="viewTitle">üí∞ Ingresar Ofrenda</div>
          <button class="btn-inline btn-soft" id="btnBackFromOfrenda">‚Üê Volver</button>
        </div>

        <div class="field">
          <label>Concepto</label>
          <select id="ofConcept" class="select"></select>
          <div class="hint">Si eliges ‚ÄúOtros‚Äù, podr√°s agregar uno nuevo (se comparte con todos).</div>
        </div>

        <div id="otherWrap" class="field hidden">
          <label>Agregar concepto (nuevo)</label>
          <input id="ofOther" class="input" placeholder="Escribe y presiona Enter‚Ä¶" />
          <div class="hint">Al presionar Enter, se guardar√° en Supabase y aparecer√° a todos.</div>
        </div>

        <div class="field">
          <label>Cantidad a ingresar (‚Ç°)</label>
          <input id="ofAmount" class="input" inputmode="numeric" placeholder="Ej: 2500" />
          <div class="hint">Solo n√∫meros. La fecha se guarda autom√°ticamente.</div>
        </div>

        <div class="field">
          <label>Testigos (obligatorio)</label>
          <input id="ofWitnesses" class="input" placeholder="Ej: Juan P√©rez, Mar√≠a L√≥pez" />
        </div>

        <div class="field">
          <label>Comentarios</label>
          <textarea id="ofComments" class="textarea" placeholder="Opcional‚Ä¶"></textarea>
        </div>

        <button id="btnSendOfrenda" class="btn btn-primary">Enviar</button>
        <div id="ofToast" class="toast hidden"></div>
      </div>

      <!-- VIEW: CONFIG -->
      <div id="viewConfig" class="view hidden">
        <div class="viewHeader">
          <div class="viewTitle">‚öôÔ∏è Configuraci√≥n</div>
          <button class="btn-inline btn-soft" id="btnBackFromConfig">‚Üê Volver</button>
        </div>

        <p style="font-size:13px; margin-bottom:10px;">
          Tu usuario est√° listo. ID: <code id="uid"></code>
        </p>

        <div class="field">
          <label>Conceptos de Ofrenda (compartidos)</label>
          <div id="conceptList" class="list"></div>
          <div class="hint">Regla actual: solo puede editar quien cre√≥ el concepto. Luego ponemos rol admin.</div>
        </div>
      </div>

      <!-- VIEW placeholders -->
      <div id="viewEgreso" class="view hidden">
        <div class="viewHeader">
          <div class="viewTitle">üìâ Ingresar Egreso</div>
          <button class="btn-inline btn-soft" id="btnBackFromEgreso">‚Üê Volver</button>
        </div>
        <p class="small">Pendiente. Lo armamos despu√©s de ofrendas.</p>
      </div>

      <div id="viewReportes" class="view hidden">
        <div class="viewHeader">
          <div class="viewTitle">üìä Reportes</div>
          <button class="btn-inline btn-soft" id="btnBackFromReportes">‚Üê Volver</button>
        </div>
        <p class="small">Pendiente. Luego hacemos reportes b√°sicos (por fecha, por concepto, totales).</p>
      </div>

      <button id="btnLogout" class="btn btn-ghost" style="margin-top:14px;">Cerrar sesi√≥n</button>
    </div>
  </div>

  <script>
    // === SUPABASE ===
    const SUPABASE_URL = "https://zcsuldbyhxsapyxfzuht.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_TU_ANON_AQUI"; // <-- ponla aqu√≠ en tu repo (no pongas service_role nunca)

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const elStatus = document.getElementById("status");
    const elLoggedOut = document.getElementById("loggedOut");
    const elLoggedIn = document.getElementById("loggedIn");
    const elName = document.getElementById("name");
    const elEmail = document.getElementById("email");
    const elUid = document.getElementById("uid");
    const elAvatar = document.getElementById("avatar");

    // views
    const viewOfrenda = document.getElementById("viewOfrenda");
    const viewEgreso = document.getElementById("viewEgreso");
    const viewReportes = document.getElementById("viewReportes");
    const viewConfig = document.getElementById("viewConfig");
    const dashboard = document.getElementById("dashboard");

    // ofrenda form
    const ofConcept = document.getElementById("ofConcept");
    const otherWrap = document.getElementById("otherWrap");
    const ofOther = document.getElementById("ofOther");
    const ofAmount = document.getElementById("ofAmount");
    const ofWitnesses = document.getElementById("ofWitnesses");
    const ofComments = document.getElementById("ofComments");
    const btnSendOfrenda = document.getElementById("btnSendOfrenda");
    const ofToast = document.getElementById("ofToast");

    // config
    const conceptList = document.getElementById("conceptList");

    let currentUser = null;
    let conceptsCache = [];

    function showLoggedOut(msg){
      elStatus.textContent = msg || "No has iniciado sesi√≥n.";
      elLoggedOut.classList.remove("hidden");
      elLoggedIn.classList.add("hidden");
    }

    function showLoggedIn(user){
      currentUser = user;
      const meta = user.user_metadata || {};
      elStatus.textContent = "Sesi√≥n activa ‚úÖ";
      elLoggedOut.classList.add("hidden");
      elLoggedIn.classList.remove("hidden");
      elName.textContent = meta.full_name || meta.name || "Usuario";
      elEmail.textContent = user.email || "";
      elUid.textContent = user.id;
      elAvatar.src = meta.avatar_url || "https://www.gravatar.com/avatar/?d=mp";
    }

    function hideAllViews(){
      viewOfrenda.classList.add("hidden");
      viewEgreso.classList.add("hidden");
      viewReportes.classList.add("hidden");
      viewConfig.classList.add("hidden");
    }

    function openView(which){
      hideAllViews();
      dashboard.classList.add("hidden");

      if (which === "ofrenda") viewOfrenda.classList.remove("hidden");
      if (which === "egreso") viewEgreso.classList.remove("hidden");
      if (which === "reportes") viewReportes.classList.remove("hidden");
      if (which === "config") viewConfig.classList.remove("hidden");
    }

    function backToDashboard(){
      hideAllViews();
      dashboard.classList.remove("hidden");
      // limpiar mensajes
      ofToast.classList.add("hidden");
      ofToast.textContent = "";
      ofToast.className = "toast hidden";
    }

    function setToastOk(msg){
      ofToast.className = "toast ok";
      ofToast.textContent = msg;
      ofToast.classList.remove("hidden");
    }
    function setToastErr(msg){
      ofToast.className = "toast err";
      ofToast.textContent = msg;
      ofToast.classList.remove("hidden");
    }

    function onlyDigits(str){
      return (str || "").replace(/[^\d]/g, "");
    }

    async function loadConcepts(){
      const { data, error } = await supabaseClient
        .from("offering_concepts")
        .select("id,label,created_by,is_active")
        .order("label", { ascending: true });

      if (error) {
        console.warn("No pude cargar offering_concepts:", error);
        conceptsCache = [];
        return;
      }
      conceptsCache = data || [];
    }

    function renderConceptSelect(){
      ofConcept.innerHTML = "";
      const opts = conceptsCache.filter(x => x.is_active);

      // fallback si est√° vac√≠o
      if (!opts.length) {
        const o = document.createElement("option");
        o.value = "";
        o.textContent = "‚Äî No hay conceptos ‚Äî";
        ofConcept.appendChild(o);
        return;
      }

      for (const c of opts) {
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.label;
        ofConcept.appendChild(o);
      }

      // si existe "Otros", lo dejamos seleccionado al final cuando el usuario lo elija
      handleConceptChange();
    }

    function handleConceptChange(){
      const selectedId = ofConcept.value;
      const selected = conceptsCache.find(x => x.id === selectedId);
      const label = (selected?.label || "").toLowerCase().trim();
      if (label === "otros") {
        otherWrap.classList.remove("hidden");
        ofOther.focus();
      } else {
        otherWrap.classList.add("hidden");
        ofOther.value = "";
      }
    }

    async function addConcept(label){
      const clean = (label || "").trim();
      if (!clean) return { ok:false, error:"empty" };

      const { data, error } = await supabaseClient
        .from("offering_concepts")
        .insert([{ label: clean, created_by: currentUser.id }])
        .select("id,label")
        .single();

      if (error) return { ok:false, error };

      return { ok:true, data };
    }

    async function renderConceptList(){
      // En Configuraci√≥n: lista editable (solo propios por policy)
      conceptList.innerHTML = "";

      const rows = conceptsCache.filter(x => x.is_active);
      if (!rows.length) {
        conceptList.innerHTML = `<div class="listRow"><div>No hay conceptos.</div></div>`;
        return;
      }

      for (const c of rows) {
        const canEdit = (c.created_by === currentUser.id);

        const row = document.createElement("div");
        row.className = "listRow";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:800">${c.label}</div><div class="small">${canEdit ? "Editable por ti" : "Creado por otro usuario"}</div>`;

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "8px";

        const btnEdit = document.createElement("button");
        btnEdit.className = "miniBtn";
        btnEdit.textContent = "Editar";
        btnEdit.disabled = !canEdit;
        btnEdit.addEventListener("click", async () => {
          const newLabel = prompt("Editar concepto:", c.label);
          if (!newLabel) return;
          const clean = newLabel.trim();
          if (!clean) return;

          const { error } = await supabaseClient
            .from("offering_concepts")
            .update({ label: clean })
            .eq("id", c.id);

          if (error) {
            alert("No se pudo editar (policy).");
            console.warn(error);
            return;
          }

          await loadConcepts();
          renderConceptSelect();
          renderConceptList();
        });

        right.appendChild(btnEdit);

        row.appendChild(left);
        row.appendChild(right);
        conceptList.appendChild(row);
      }
    }

    async function submitOffering(){
      // validaciones
      const amountRaw = onlyDigits(ofAmount.value);
      const amount = Number(amountRaw);
      if (!amountRaw || !Number.isFinite(amount) || amount <= 0) {
        setToastErr("La cantidad debe ser un n√∫mero mayor a 0.");
        return;
      }

      const witnesses = (ofWitnesses.value || "").trim();
      if (!witnesses) {
        setToastErr("Testigos es obligatorio.");
        return;
      }

      const conceptId = ofConcept.value;
      const conceptObj = conceptsCache.find(x => x.id === conceptId);
      const conceptLabel = conceptObj?.label?.trim();

      if (!conceptId || !conceptLabel) {
        setToastErr("Selecciona un concepto v√°lido.");
        return;
      }

      btnSendOfrenda.disabled = true;
      btnSendOfrenda.textContent = "Enviando‚Ä¶";

      const payload = {
        amount,
        concept_id: conceptId,
        concept_label: conceptLabel,
        witnesses,
        comments: (ofComments.value || "").trim() || null,
        created_by: currentUser.id
        // created_at lo pone Postgres con default now()
      };

      const { data, error } = await supabaseClient
        .from("offerings")
        .insert([payload])
        .select("id, created_at")
        .single();

      btnSendOfrenda.disabled = false;
      btnSendOfrenda.textContent = "Enviar";

      if (error) {
        console.warn("Insert offerings error:", error);
        setToastErr("No se pudo enviar. Revisa permisos (RLS) o conexi√≥n.");
        return;
      }

      setToastOk(`‚úÖ Enviado y recibido en la base de datos. ID: ${data.id}`);

      // reset parcial
      ofAmount.value = "";
      ofWitnesses.value = "";
      ofComments.value = "";
    }

    async function setupAfterLogin(){
      await loadConcepts();
      renderConceptSelect();
      await renderConceptList();
    }

    async function refreshUI(){
      const { data, error } = await supabaseClient.auth.getSession();
      if (error) {
        console.warn("getSession error:", error);
        showLoggedOut("Error leyendo sesi√≥n.");
        return;
      }

      const session = data?.session;
      if (!session?.user) {
        showLoggedOut("No has iniciado sesi√≥n.");
        return;
      }

      showLoggedIn(session.user);
      await setupAfterLogin();
    }

    // Events
    document.getElementById("btnGoogle").addEventListener("click", async () => {
      const redirectTo = "https://jeffcrtra.github.io/Ofrendas/index.html";
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo }
      });
      if (error) {
        console.error(error);
        alert("No se pudo iniciar sesi√≥n con Google.");
      }
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      const { error } = await supabaseClient.auth.signOut();
      if (error) console.error(error);
      currentUser = null;
      showLoggedOut("Sesi√≥n cerrada.");
      backToDashboard();
    });

    // dashboard tiles
    document.querySelectorAll(".tile").forEach(btn => {
      btn.addEventListener("click", async () => {
        const which = btn.dataset.open;
        openView(which);

        if (which === "config") {
          // refrescar lista por si alguien agreg√≥ nuevos
          await loadConcepts();
          renderConceptSelect();
          await renderConceptList();
        }
      });
    });

    // back buttons
    document.getElementById("btnBackFromOfrenda").addEventListener("click", backToDashboard);
    document.getElementById("btnBackFromConfig").addEventListener("click", backToDashboard);
    document.getElementById("btnBackFromEgreso").addEventListener("click", backToDashboard);
    document.getElementById("btnBackFromReportes").addEventListener("click", backToDashboard);

    // concept change
    ofConcept.addEventListener("change", handleConceptChange);

    // add other concept on Enter
    ofOther.addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();

      const newLabel = ofOther.value;
      ofOther.disabled = true;

      const res = await addConcept(newLabel);

      ofOther.disabled = false;

      if (!res.ok) {
        console.warn("addConcept failed:", res.error);
        setToastErr("No se pudo agregar el concepto (quiz√° ya existe o no tienes permiso).");
        return;
      }

      await loadConcepts();
      renderConceptSelect();

      // seleccionar el nuevo concepto
      ofConcept.value = res.data.id;
      handleConceptChange(); // esto esconder√° el input porque ya no es ‚ÄúOtros‚Äù
      setToastOk(`‚úÖ Concepto agregado: ${res.data.label}`);

      // tambi√©n refresca config list
      await renderConceptList();
    });

    // submit offering
    btnSendOfrenda.addEventListener("click", submitOffering);

    // auth changes
    supabaseClient.auth.onAuthStateChange(() => {
      refreshUI();
    });

    // init
    refreshUI();
  </script>
</body>
</html>
